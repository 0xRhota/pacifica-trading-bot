## Codebase Patterns - Hibachi

- Hibachi Grid MM: `scripts/grid_mm_hibachi.py` - uses 30s time-based refresh (WORKING)
- Hibachi LLM Bot: `hibachi_agent/bot_hibachi.py` - Strategy F with Qwen
- Fast Exit Monitor: `hibachi_agent/execution/fast_exit_monitor.py` - checks TP/SL every 30s
- Hibachi SDK: `dexes/hibachi/hibachi_sdk.py`
- Market Aggregator: `hibachi_agent/data/hibachi_aggregator.py` - fetches indicators
- Whitelist excludes BTC (handled by Grid MM separately)

---

## 2026-01-22 - Initial State

**Grid MM (BTC):**
- Balance: $47.22
- PnL: -$2.80 today
- Dynamic spread: 10-20 bps based on ROC
- PAUSE logic working (pauses during trends)
- Placing orders successfully

**LLM Directional:**
- Just closed BTC SHORT with +7.99% profit (166 hours hold - time exit)
- Opened XRP LONG
- Fast exit monitor: 17 exits triggered today
- DOGE blocked (9% win rate)

**Key Metrics to Improve:**
- Grid MM fill rate
- LLM win rate (currently ~40%)
- Combined daily P&L (target: positive)

---

## 2026-01-22 12:54 - HIB-001 Complete

**Added: Momentum Confirmation to LLM Scoring**

Implementation in `hibachi_agent/bot_hibachi.py`:
- `calculate_momentum()`: Calculates 5-minute price momentum from kline_df
- `check_momentum_confirmation()`: Validates momentum direction matches LLM signal
- Logs momentum value (e.g., "ðŸ“ˆ 5-min Momentum: +0.15% (BULLISH)")
- Vetoes trades where momentum conflicts (e.g., LONG when momentum is BEARISH)

Logic:
- Momentum > +0.05% = BULLISH
- Momentum < -0.05% = BEARISH
- Otherwise = NEUTRAL (weak confirmation, allowed)

Expected impact:
- Fewer false signals by requiring short-term momentum confirmation
- Better entry timing

---

## 2026-01-22 12:57 - HIB-002 Complete

**Added: Trailing Stop for Winning Trades**

Implementation in `hibachi_agent/execution/fast_exit_monitor.py`:
- Thresholds: BREAKEVEN at +4%, TRAILING at +6%, TRAIL DISTANCE 2%
- `check_trailing_stop()`: Evaluates and updates trailing stops
- `clear_trailing_stop()`: Cleans up tracking on position close
- Tracks peak P&L to ratchet stop upward only

Logic:
1. Position hits +4% â†’ breakeven lock activated (exit if drops to 0%)
2. Position hits +6% â†’ trailing stop at +4%
3. Position hits +8% â†’ trailing stop raises to +6%
4. If price drops to trailing stop â†’ exit

Example from notes: BTC SHORT closed at +7.99% - would now lock in +5.99% minimum

---

## 2026-01-22 13:00 - HIB-003 Complete

**Optimized: Grid MM Spread for Hibachi**

**Analysis of logs/grid_mm_hibachi.log:**
- 360 cycles over 218 minutes
- Balance dropped from $50.02 â†’ $47.22 (PnL: -$2.80)
- No fill events logged (orders cancelled every 30s before fills)
- ROC-based pausing working correctly
- Dynamic spread ranged 10-25 bps

**Findings:**
- Orders placed and cancelled without fills indicates spread too wide
- CLAUDE.md confirms: "Wider Grid MM spreads DON'T work (v2-v4 proved it)"
- Decision: REDUCE spreads by 20% to increase fill rate

**New Spread Bands:**
| ROC (abs) | Old Spread | New Spread |
|-----------|------------|------------|
| 0-5 bps   | 10 bps     | 8 bps      |
| 5-10 bps  | 15 bps     | 12 bps     |
| 10-20 bps | 20 bps     | 16 bps     |
| > 20 bps  | 25 bps     | 20 bps     |

---

## 2026-01-22 13:05 - HIB-004 Complete

**Added: Win Rate Tracking Per Asset**

Implementation in `llm_agent/self_learning.py`:
- `get_blocked_symbols()`: Returns symbols with <30% WR over 10+ trades
- `is_symbol_blocked()`: Checks if specific symbol should be blocked
- `log_win_rate_summary()`: Formatted summary for logging

Integration in `hibachi_agent/bot_hibachi.py`:
- Logs win rate summary during self-learning check-in (every 30 min)
- Blocks trades on symbols with <30% WR (10+ trade minimum)

Example output:
```
ðŸ“Š WIN RATE SUMMARY BY ASSET
  ETH/USDT-P: 48% WR (12/25 trades, $+15.50) âš ï¸ WATCH
  SOL/USDT-P: 40% WR (4/10 trades, $-38.00) âš ï¸ WATCH
  DOGE/USDT-P: 9% WR (1/11 trades, $-25.00) â›” BLOCKED
ðŸš« 1 symbol(s) BLOCKED (<30% WR with 10+ trades)
```

---

## 2026-01-22 13:12 - HIB-005 Complete

**Added: LLM API Call Caching**

Implementation in `hibachi_agent/data/hibachi_aggregator.py`:
- Indicator cache with 60-second TTL
- 0.1% price change threshold to invalidate cache
- Methods: `_is_cache_valid()`, `_update_cache()`, `get_cache_stats()`, `log_cache_stats()`
- `has_significant_change()`: Checks if any market warrants LLM analysis

Integration in `hibachi_agent/bot_hibachi.py`:
- Skip LLM call if no significant change AND no open positions
- Always call LLM with open positions (need exit monitoring)
- Log cache hit rate each cycle

**Cache Skip Logic:**
- Price moved < 0.1% â†’ cache hit â†’ no recalculation
- No cache misses AND no positions â†’ skip LLM
- RSI extreme (<30 or >70) â†’ always analyze

**Expected Cost Savings:**
- Current: ~$0.01 per LLM call Ã— 6 calls/hour = ~$0.06/hour
- With caching: Skip ~50% of calls during calm markets = ~$0.03/hour saved
- Monthly estimate: ~$22/month â†’ ~$11/month (50% reduction)

---

## 2026-01-22 13:17 - HIB-006 Complete

**Added: Position Sizing Based on Conviction**

Implementation in `hibachi_agent/bot_hibachi.py`:
- Confidence 0.7-0.8: 1.0x base size ($10)
- Confidence 0.8-0.9: 1.5x size ($15)
- Confidence 0.9+: 2.0x size ($20)
- Hard cap: Never exceed 50% of available margin

Note: Per CLAUDE.md, high confidence doesn't correlate with actual win rate
(0.9 conf = 51.7% actual WR), but larger size on strong signals can still
capture bigger moves when right.

---

## 2026-01-22 13:20 - HIB-007 Complete

**Created: Hibachi Performance Dashboard**

New script: `scripts/hibachi_dashboard.py`

Features:
- ðŸ’° Account Summary: Balance, open positions
- ðŸ¤– LLM Bot Stats: Wins/losses, win rate, P&L by symbol
- ðŸ“ˆ Grid MM Stats: Cycles, runtime, P&L
- ðŸ“Š Combined Daily: Total P&L from both strategies

Usage:
```bash
python3 scripts/hibachi_dashboard.py          # Run once
python3 scripts/hibachi_dashboard.py --watch  # Auto-refresh every 30s
```

---

## 2026-01-22 13:25 - HIB-008 Status

**Final Hibachi Optimization and Documentation**

Status: PENDING LIVE TEST

Completed acceptance criteria:
- âœ… All previous stories (HIB-001 to HIB-007) implemented and working
- âœ… Document final configuration in PROGRESS.md
- âœ… Document learnings in LEARNINGS.md

Pending:
- â³ Run 24-hour live test
- â³ Target: breakeven or profitable over 24h

**To start 24h test:**
```bash
# Start Grid MM (BTC)
nohup python3 scripts/grid_mm_hibachi.py > logs/grid_mm_hibachi.log 2>&1 &

# Start LLM Directional
nohup python3 -u -m hibachi_agent.bot_hibachi --live --interval 600 > logs/hibachi_bot.log 2>&1 &
```

**To check progress:**
```bash
python3 scripts/hibachi_dashboard.py
```

---
